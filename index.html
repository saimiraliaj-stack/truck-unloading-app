<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Truck Unloading App</title>

  <!-- ====== Fonts / Base ====== -->
  <style>
    :root{
      --bg0:#08111b;
      --bg1:#0b1a2a;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.12);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.68);
      --brand:#2ea8ff;
      --brand2:#37e6d2;
      --good:#25d366;
      --bad:#ff4d4d;
      --warn:#ffcc00;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(46,168,255,.28), transparent 55%),
        radial-gradient(900px 550px at 85% 20%, rgba(55,230,210,.18), transparent 60%),
        radial-gradient(1000px 700px at 40% 110%, rgba(46,168,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:22px 16px 60px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:16px 18px;
      border:1px solid var(--stroke);
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: 0 30px 120px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(46,168,255,.9), rgba(55,230,210,.65));
      display:grid;place-items:center;
      box-shadow: 0 10px 40px rgba(46,168,255,.28);
      border:1px solid rgba(255,255,255,.16);
    }
    .logo svg{filter:drop-shadow(0 8px 18px rgba(0,0,0,.35))}
    h1{margin:0;font-size:18px;letter-spacing:.3px}
    .sub{margin-top:2px;color:var(--muted);font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-size:12px;color:var(--muted);
      user-select:none;
    }
    .chip b{color:var(--text)}
    .tabs{
      margin-top:16px;
      display:flex; gap:10px; flex-wrap:wrap;
      padding:12px;
      border-radius:22px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }
    .tab{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:800;
      display:flex; align-items:center; gap:8px;
    }
    .tab.active{
      border-color: rgba(46,168,255,.55);
      background: linear-gradient(135deg, rgba(46,168,255,.28), rgba(55,230,210,.12));
      box-shadow: 0 12px 45px rgba(46,168,255,.12);
    }
    .panel{
      margin-top:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius:24px;
      overflow:hidden;
    }
    .panelHeader{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .panelHeader h2{margin:0;font-size:14px}
    .panelHeader small{color:var(--muted)}
    .panelBody{padding:16px}
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .85fr;
      gap:14px;
    }
    @media(max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:22px;
      padding:14px;
    }
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input, select{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
    }
    input::placeholder{color:rgba(234,242,255,.42)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    .btn{
      border:1px solid rgba(46,168,255,.45);
      background: linear-gradient(135deg, rgba(46,168,255,.9), rgba(46,168,255,.45));
      color:#06111b;
      font-weight:900;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      box-shadow: 0 10px 35px rgba(46,168,255,.20);
    }
    .btn.secondary{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      box-shadow:none;
    }
    .btn.danger{
      border:1px solid rgba(255,77,77,.45);
      background: linear-gradient(135deg, rgba(255,77,77,.95), rgba(255,77,77,.45));
      color:#110707;
      box-shadow: 0 10px 35px rgba(255,77,77,.18);
    }
    .btn:disabled{opacity:.45;cursor:not-allowed;filter:saturate(.6)}
    .slotGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    @media(max-width: 720px){ .slotGrid{grid-template-columns:1fr} }
    .slot{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .slot .t{font-weight:900}
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .badge.good{border-color:rgba(37,211,102,.35); color:#c7ffe0}
    .badge.bad{border-color:rgba(255,77,77,.35); color:#ffd1d1}
    .badge.warn{border-color:rgba(255,204,0,.35); color:#fff1b0}
    .hint{color:var(--muted);font-size:12px;line-height:1.45}
    .statusBox{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:12px;
      font-size:13px;
      line-height:1.35;
    }
    .footerNote{margin-top:10px;color:var(--muted);font-size:12px}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{color:var(--muted);font-size:12px;text-align:left;padding:0 10px}
    td{
      padding:12px 10px;
      background: rgba(255,255,255,.04);
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    td:first-child{border-left:1px solid rgba(255,255,255,.08);border-radius:14px 0 0 14px}
    td:last-child{border-right:1px solid rgba(255,255,255,.08);border-radius:0 14px 14px 0}
    .mono{font-family:var(--mono);font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    /* ===== Modals ===== */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(960px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(15,34,52,.98), rgba(10,18,28,.92));
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .modalHeader h3{margin:0;font-size:14px}
    .iconBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modalBody{padding:16px}
    .kvGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){ .kvGrid{grid-template-columns:1fr} }
    .kv{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      padding:12px;
    }
    .kv .k{color:var(--muted); font-size:12px; margin-bottom:6px}
    .kv .v{font-weight:900}
    .modalFooter{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    /* ===== Scanner ===== */
    .scannerBox{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }
    .scannerTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .scannerVideoWrap{
      position:relative;
      aspect-ratio: 16/9;
      background:#000;
    }
    video#scanVideo{width:100%;height:100%;object-fit:cover;display:block}
    .scanAim{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none}
    .scanAim::before{
      content:"";
      width:min(68%, 420px);
      height:min(55%, 280px);
      border:2px solid rgba(46,168,255,.8);
      border-radius: 16px;
      box-shadow: 0 0 0 999px rgba(0,0,0,.18);
    }
  </style>

  <!-- ====== External libs (CDN) ====== -->
  <!-- jsPDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- QR Code -->
  <script defer src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- JsBarcode (CODE128) -->
  <script defer src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
            <path d="M4 7.5c0-1.38 1.12-2.5 2.5-2.5h7C14.88 5 16 6.12 16 7.5v10c0 1.38-1.12 2.5-2.5 2.5h-7C5.12 20 4 18.88 4 17.5v-10Z" stroke="white" stroke-width="1.8"/>
            <path d="M16 9h1.3c.56 0 1.1.22 1.5.62l1.6 1.6c.4.4.62.94.62 1.5V17.5c0 1.38-1.12 2.5-2.5 2.5H16" stroke="white" stroke-width="1.8"/>
            <path d="M7 9h6M7 12h6M7 15h4" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Truck Unloading App</h1>
          <div class="sub">Carrier booking + cancel ‚Ä¢ Scan ticket ‚Ä¢ Internal dashboard (locked)</div>
        </div>
      </div>

      <div class="chips">
        <div class="chip">üìÑ <b>Modern PDF</b></div>
        <div class="chip">üè∑Ô∏è <b>Barcode</b> CODE128</div>
        <div class="chip">üî≥ <b>QR</b> ticket</div>
        <div class="chip">üìä <b>Excel</b> export</div>
        <div class="chip">üîí <b>Internal</b> (1234)</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="carrierBooking">üöö Carrier booking</button>
      <button class="tab" data-tab="carrierCancel">üß® Carrier cancel</button>
      <button class="tab" data-tab="scanTicket">üì∑ Scan ticket</button>
      <button class="tab" data-tab="internal">üõ°Ô∏è Internal (locked)</button>
    </div>

    <!-- ===== Carrier Booking ===== -->
    <section class="panel" id="tab_carrierBooking">
      <div class="panelHeader">
        <h2>Carrier booking</h2>
        <small>Date is Europe/Berlin</small>
      </div>
      <div class="panelBody">
        <div class="grid">
          <div class="card">
            <div class="row">
              <div class="col">
                <label>Date</label>
                <input id="dateInput" type="date" />
              </div>
              <div class="col">
                <label>Working hours</label>
                <select id="hoursSelect">
                  <option value="08:00-16:00">08:00‚Äì16:00</option>
                  <option value="06:00-14:00">06:00‚Äì14:00</option>
                  <option value="14:00-22:00">14:00‚Äì22:00</option>
                </select>
              </div>
              <div class="col" style="min-width:220px">
                <label>&nbsp;</label>
                <button class="btn" id="loadSlotsBtn">Load slots</button>
              </div>
            </div>

            <div class="hint" style="margin-top:10px">
              Select an available slot (2 hours). After booking you get a <b>Booking ID</b> and can download a PDF with <b>Barcode + QR</b>.
            </div>

            <div class="slotGrid" id="slotGrid"></div>
            <div class="hint" id="slotHint" style="margin-top:10px"></div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 10px">Carrier details</h3>

            <label>Company / Carrier *</label>
            <input id="companyInput" placeholder="e.g. DHL / DB Schenker / ..." />

            <div style="height:10px"></div>

            <label>Truck plate *</label>
            <input id="plateInput" placeholder="DU-AB 1234" />

            <div style="height:10px"></div>

            <label>Driver phone *</label>
            <input id="phoneInput" placeholder="+49 ..." />

            <div style="height:10px"></div>

            <label>Package No *</label>
            <input id="packageInput" placeholder="PKG-001" />

            <div class="statusBox" id="bookingStatus" style="display:none"></div>

            <div style="margin-top:12px" class="row">
              <button class="btn secondary" id="downloadCarrierPdfBtn" disabled>Download PDF (Carrier)</button>
              <button class="btn secondary" id="downloadInternalPdfBtn" disabled>Download PDF (Internal)</button>
            </div>

            <div class="footerNote">
              Booking ID format: <span class="mono">Carrier-Plate-Package-XXX</span> (safe characters)
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Carrier Cancel ===== -->
    <section class="panel" id="tab_carrierCancel" style="display:none">
      <div class="panelHeader">
        <h2>Carrier cancel</h2>
        <small>Cancel by Booking ID only</small>
      </div>
      <div class="panelBody">
        <div class="grid">
          <div class="card">
            <label>Booking ID *</label>
            <input id="cancelId" placeholder="Carrier-Plate-Package-123" />
            <div style="height:10px"></div>
            <label>Reason *</label>
            <input id="cancelReason" placeholder="e.g. Delay / wrong slot / ..."/>
            <div style="height:14px"></div>
            <button class="btn danger" id="cancelBtn">Cancel booking</button>

            <div class="statusBox" id="cancelStatus" style="display:none"></div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 10px">Rules</h3>
            <div class="hint">
              ‚Ä¢ Cancel marks the booking as <b>CANCELLED</b>.<br>
              ‚Ä¢ Cancelled bookings get a PDF with a big red X.<br>
              ‚Ä¢ Cancel does not delete; it keeps history.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Scan Ticket ===== -->
    <section class="panel" id="tab_scanTicket" style="display:none">
      <div class="panelHeader">
        <h2>Scan ticket</h2>
        <small>Use camera to scan QR/Barcode or paste Booking ID</small>
      </div>
      <div class="panelBody">
        <div class="grid">
          <div class="card">
            <div class="row">
              <div class="col">
                <label>Booking ID</label>
                <input id="scanId" placeholder="Carrier-Plate-Package-123" />
              </div>
              <div class="col" style="min-width:220px">
                <label>&nbsp;</label>
                <button class="btn" id="findBtn">Find booking</button>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="openCameraBtn">Open camera scanner</button>
              <button class="btn secondary" id="focusScanBtn" title="For handheld scanners that type into the field">Use handheld scanner</button>
            </div>

            <div class="statusBox" id="scanInline" style="display:none"></div>

            <div class="footerNote">
              Camera scanning works best on <b>Edge / Chrome</b>. If not available, paste the Booking ID manually.
            </div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 10px">Flow</h3>
            <div class="hint">
              ‚Ä¢ Scan ‚Üí popup shows all details.<br>
              ‚Ä¢ Click <b>ARRIVED</b> when truck is at gate.<br>
              ‚Ä¢ Click <b>DONE</b> when unloading is finished.<br>
              ‚Ä¢ If not marked done: it becomes <b>DONE (AUTO)</b> after slot end.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Internal Locked ===== -->
    <section class="panel" id="tab_internal" style="display:none">
      <div class="panelHeader">
        <h2>Internal dashboard</h2>
        <small>Protected view</small>
      </div>
      <div class="panelBody">
        <div class="card" id="lockBox">
          <div class="row">
            <div class="col">
              <label>Passcode</label>
              <input id="passInput" type="password" placeholder="Enter passcode" />
            </div>
            <div class="col" style="min-width:220px">
              <label>&nbsp;</label>
              <button class="btn" id="unlockBtn">Unlock</button>
            </div>
          </div>
          <div class="footerNote">For now: <b>1234</b></div>
          <div class="statusBox" id="lockStatus" style="display:none"></div>
        </div>

        <div class="card" id="internalBox" style="display:none">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div>
              <h3 style="margin:0 0 6px">Bookings</h3>
              <div class="hint">Shows status, arrived/done timestamps, cancel reasons, and auto-completions.</div>
            </div>
            <div class="actions">
              <button class="btn secondary" id="exportExcelBtn">Excel export</button>
              <button class="btn secondary" id="refreshBtn">Refresh</button>
            </div>
          </div>

          <div style="height:12px"></div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Slot</th>
                  <th>Status</th>
                  <th>Company</th>
                  <th>Plate</th>
                  <th>Package</th>
                  <th class="mono">Booking ID</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="internalTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== Details Modal ===== -->
  <div class="modalOverlay" id="detailsModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>Shipment details</h3>
        <button class="iconBtn" id="closeDetails">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="kvGrid">
          <div class="kv"><div class="k">Status</div><div class="v" id="m_status">‚Äî</div></div>
          <div class="kv"><div class="k">Booking ID</div><div class="v mono" id="m_id">‚Äî</div></div>
          <div class="kv"><div class="k">Date</div><div class="v" id="m_date">‚Äî</div></div>
          <div class="kv"><div class="k">Slot</div><div class="v" id="m_slot">‚Äî</div></div>
          <div class="kv"><div class="k">Company</div><div class="v" id="m_company">‚Äî</div></div>
          <div class="kv"><div class="k">Truck plate</div><div class="v" id="m_plate">‚Äî</div></div>
          <div class="kv"><div class="k">Driver phone</div><div class="v" id="m_phone">‚Äî</div></div>
          <div class="kv"><div class="k">Package No</div><div class="v" id="m_pkg">‚Äî</div></div>
          <div class="kv" id="m_autoWrap" style="display:none"><div class="k">Completion</div><div class="v">Completed automatically (slot ended)</div></div>
          <div class="kv" id="m_cancelWrap" style="display:none"><div class="k">Cancel reason</div><div class="v" id="m_cancelReason">‚Äî</div></div>
          <div class="kv" id="m_arrivedWrap" style="display:none"><div class="k">Arrived at</div><div class="v" id="m_arrivedAt">‚Äî</div></div>
          <div class="kv" id="m_doneWrap" style="display:none"><div class="k">Done at</div><div class="v" id="m_doneAt">‚Äî</div></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn secondary" id="m_pdfCarrier">Carrier PDF</button>
        <button class="btn secondary" id="m_pdfInternal">Internal PDF</button>
        <button class="btn danger" id="m_pdfCancelled">Cancelled PDF</button>
        <span style="flex:1"></span>
        <button class="btn" id="m_arrived">Mark ARRIVED</button>
        <button class="btn" id="m_done">Mark DONE</button>
      </div>
    </div>
  </div>

  <!-- ===== Scanner Modal ===== -->
  <div class="modalOverlay" id="scannerModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>Camera scanner (QR / Barcode)</h3>
        <button class="iconBtn" id="closeScanner">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="scannerBox">
          <div class="scannerTop">
            <div class="hint" id="scanStatusText">Allow camera access to start scanning‚Ä¶</div>
            <div class="actions">
              <button class="btn secondary" id="switchCamBtn">Switch camera</button>
              <button class="btn danger" id="stopCamBtn">Stop</button>
            </div>
          </div>
          <div class="scannerVideoWrap">
            <video id="scanVideo" autoplay playsinline muted></video>
            <div class="scanAim"></div>
          </div>
        </div>
        <div class="footerNote">Tip: keep code inside the frame. If it fails, paste Booking ID manually.</div>
      </div>
    </div>
  </div>

  <script>
    /*********************
     * Safe helpers
     *********************/
    const $ = (id)=>document.getElementById(id);

    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function cleanPart(s){
      return String(s||"")
        .trim()
        .replace(/\s+/g,"-")
        .replace(/[^a-zA-Z0-9\-_.]/g,"")
        .slice(0,60) || "X";
    }
    function showBox(el, title, body, tone=""){
      el.style.display="block";
      el.innerHTML = `<b>${title}</b><div style="margin-top:6px; color: var(--muted)">${body}</div>`;
      el.style.borderColor = tone==="bad" ? "rgba(255,77,77,.45)" : tone==="good" ? "rgba(37,211,102,.35)" : "rgba(255,255,255,.12)";
    }

    /*********************
     * Storage
     *********************/
    const STORAGE_KEY="truck_unloading_bookings_v3";
    function loadAll(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }
      catch(e){ return []; }
    }
    function saveAll(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }
    function updateBooking(id, patch){
      const all = loadAll();
      const idx = all.findIndex(b=>b.id===id);
      if(idx<0) return null;
      all[idx] = {...all[idx], ...patch};
      saveAll(all);
      return all[idx];
    }

    /*********************
     * Status logic
     *********************/
    function statusLabel(b){
      if(b.cancelled) return "CANCELLED";
      if(b.doneAt) return b.completedAutomatically ? "DONE (AUTO)" : "DONE";
      if(b.arrivedAt) return "ARRIVED";
      return "ACTIVE";
    }
    function slotEndDate(b){
      const [yy,mm,dd]=b.date.split("-").map(Number);
      const [hh,mi]=String(b.end||"00:00").split(":").map(Number);
      return new Date(yy,mm-1,dd,hh,mi,0,0);
    }
    function autoCompleteIfNeeded(){
      const now = new Date();
      const all = loadAll();
      let changed=false;
      for(const b of all){
        if(b.cancelled) continue;
        if(b.doneAt) continue;
        if(now > slotEndDate(b)){
          b.doneAt = new Date().toISOString();
          b.completedAutomatically = true;
          changed=true;
        }
      }
      if(changed) saveAll(all);
      return changed;
    }

    /*********************
     * Tabs
     *********************/
    const tabBtns = [...document.querySelectorAll(".tab")];
    const tabIds = ["carrierBooking","carrierCancel","scanTicket","internal"];
    function openTab(name){
      tabBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
      tabIds.forEach(t=>{
        $("tab_"+t).style.display = (t===name) ? "block" : "none";
      });
      if(name==="internal") refreshInternal();
    }
    tabBtns.forEach(b=>b.addEventListener("click", ()=>openTab(b.dataset.tab)));

    /*********************
     * Slots (2h)
     *********************/
    function buildSlots(hoursStr){
      const [start,end] = hoursStr.split("-");
      const [sh,sm]=start.split(":").map(Number);
      const [eh,em]=end.split(":").map(Number);
      const slots=[];
      let cur = sh*60+sm;
      const endm = eh*60+em;
      while(cur+120<=endm){
        const s = `${pad2(Math.floor(cur/60))}:${pad2(cur%60)}`;
        const e = `${pad2(Math.floor((cur+120)/60))}:${pad2((cur+120)%60)}`;
        slots.push({start:s,end:e});
        cur += 120;
      }
      return slots;
    }

    function renderSlots(){
      autoCompleteIfNeeded();
      const date = $("dateInput").value;
      const slots = buildSlots($("hoursSelect").value);
      const all = loadAll();
      const grid = $("slotGrid");
      grid.innerHTML="";

      let bookedCount=0;
      for(const s of slots){
        const exists = all.find(b=>b.date===date && b.start===s.start && !b.cancelled);
        const div = document.createElement("div");
        div.className="slot";
        const left = document.createElement("div");
        left.innerHTML = `<div class="t">${s.start} ‚Äì ${s.end}</div><div class="hint">2h slot</div>`;
        const right = document.createElement("div");
        const badge = document.createElement("span");
        if(exists){
          bookedCount++;
          badge.className="badge bad";
          badge.textContent = statusLabel(exists)==="DONE" || statusLabel(exists)==="DONE (AUTO)" ? "Completed" : "Booked";
          right.appendChild(badge);
          const btn = document.createElement("button");
          btn.className="btn secondary";
          btn.textContent="Book";
          btn.disabled=true;
          right.appendChild(btn);
        }else{
          badge.className="badge good";
          badge.textContent="Free";
          right.appendChild(badge);
          const btn = document.createElement("button");
          btn.className="btn";
          btn.textContent="Book";
          btn.addEventListener("click", ()=>bookSlot(date, s.start, s.end));
          right.appendChild(btn);
        }
        div.appendChild(left);
        div.appendChild(right);
        grid.appendChild(div);
      }

      $("slotHint").textContent = bookedCount ? `Booked: ${bookedCount} slot(s).` : `No bookings yet for this date.`;
    }

    /*********************
     * Booking create
     *********************/
    let lastBookingId=null;

    function bookSlot(date, start, end){
      const company = $("companyInput").value.trim();
      const plate = $("plateInput").value.trim();
      const phone = $("phoneInput").value.trim();
      const packageNo = $("packageInput").value.trim();

      if(!company || !plate || !phone || !packageNo){
        showBox($("bookingStatus"), "Missing fields", "Company, plate, phone and package number are mandatory.", "bad");
        return;
      }

      autoCompleteIfNeeded();
      const all=loadAll();
      const exists = all.find(b=>b.date===date && b.start===start && !b.cancelled);
      if(exists){
        showBox($("bookingStatus"), "Slot not available", "This slot is already booked.", "bad");
        renderSlots();
        return;
      }

      const safeCompany = cleanPart(company);
      const safePlate = cleanPart(plate);
      const safePkg = cleanPart(packageNo);
      const rand = Math.floor(100 + Math.random()*900);
      const id = `${safeCompany}-${safePlate}-${safePkg}-${rand}`;

      const booking = {
        id,
        date,
        start,
        end,
        company,
        plate,
        phone,
        packageNo,
        cancelled:false,
        cancelReason:"",
        createdAt:new Date().toISOString(),
        arrivedAt:"",
        doneAt:"",
        completedAutomatically:false
      };

      all.push(booking);
      saveAll(all);

      lastBookingId = id;
      $("downloadCarrierPdfBtn").disabled=false;
      $("downloadInternalPdfBtn").disabled=false;

      showBox($("bookingStatus"), "Booked successfully", `Booking ID: <span class="mono">${id}</span>`, "good");
      renderSlots();
      refreshInternal();
    }

    $("loadSlotsBtn").addEventListener("click", renderSlots);

    /*********************
     * Cancel
     *********************/
    $("cancelBtna");
    $("cancelBtn").addEventListener("click", ()=>{
      const id = $("cancelId").value.trim();
      const reason = $("cancelReason").value.trim();
      if(!id || !reason){
        showBox($("cancelStatus"), "Missing", "Booking ID and reason are required.", "bad");
        return;
      }
      const all=loadAll();
      const b = all.find(x=>x.id===id);
      if(!b){
        showBox($("cancelStatus"), "Not found", "No booking found with this ID.", "bad");
        return;
      }
      if(b.cancelled){
        showBox($("cancelStatus"), "Already cancelled", "This booking is already cancelled.", "warn");
        return;
      }
      b.cancelled=true;
      b.cancelReason=reason;
      saveAll(all);
      showBox($("cancelStatus"), "Cancelled", "Booking marked as CANCELLED.", "good");
      renderSlots();
      refreshInternal();
    });

    /*********************
     * Internal lock + table
     *********************/
    let internalUnlocked=false;

    $("unlockBtn").addEventListener("click", ()=>{
      const p = $("passInput").value.trim();
      if(p==="1234"){
        internalUnlocked=true;
        $("lockBox").style.display="none";
        $("internalBox").style.display="block";
        showBox($("lockStatus"), "Unlocked", "Access granted.", "good");
        refreshInternal();
      }else{
        showBox($("lockStatus"), "Wrong passcode", "Try again.", "bad");
      }
    });

    function badgeHtmlForStatus(st){
      if(st==="CANCELLED") return `<span class="badge bad">CANCELLED</span>`;
      if(st==="DONE") return `<span class="badge good">DONE</span>`;
      if(st==="DONE (AUTO)") return `<span class="badge warn">DONE (AUTO)</span>`;
      if(st==="ARRIVED") return `<span class="badge warn">ARRIVED</span>`;
      return `<span class="badge good">ACTIVE</span>`;
    }

    function refreshInternal(){
      autoCompleteIfNeeded();
      if(!internalUnlocked) return;
      const tbody = $("internalTbody");
      const all = loadAll().slice().sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
      tbody.innerHTML="";

      for(const b of all){
        const tr=document.createElement("tr");
        const st=statusLabel(b);

        tr.innerHTML = `
          <td>${b.date}</td>
          <td>${b.start}‚Äì${b.end}</td>
          <td>${badgeHtmlForStatus(st)}</td>
          <td>${escapeHtml(b.company||"")}</td>
          <td>${escapeHtml(b.plate||"")}</td>
          <td>${escapeHtml(b.packageNo||"")}</td>
          <td class="mono">${escapeHtml(b.id)}</td>
          <td>
            <div class="actions">
              <button class="btn secondary" data-act="arrived" data-id="${b.id}">Arrived</button>
              <button class="btn secondary" data-act="done" data-id="${b.id}">Done</button>
              <button class="btn secondary" data-act="view" data-id="${b.id}">View</button>
              <button class="btn danger" data-act="cancel" data-id="${b.id}">Cancel</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);

        const btnArr = tr.querySelector('[data-act="arrived"]');
        const btnDone = tr.querySelector('[data-act="done"]');
        if(b.cancelled || b.arrivedAt || b.doneAt) btnArr.disabled=true;
        if(b.cancelled || b.doneAt) btnDone.disabled=true;
      }

      tbody.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id=btn.dataset.id;
          const act=btn.dataset.act;
          const b=loadAll().find(x=>x.id===id);
          if(!b) return;

          if(act==="view"){ openDetailsModal(b); return; }

          if(act==="arrived"){
            if(b.cancelled || b.arrivedAt || b.doneAt) return;
            updateBooking(id,{arrivedAt:new Date().toISOString(), completedAutomatically:false});
            refreshInternal(); renderSlots();
            return;
          }
          if(act==="done"){
            if(b.cancelled || b.doneAt) return;
            updateBooking(id,{doneAt:new Date().toISOString(), completedAutomatically:false});
            refreshInternal(); renderSlots();
            return;
          }
          if(act==="cancel"){
            const reason = prompt("Cancel reason?");
            if(!reason) return;
            updateBooking(id,{cancelled:true, cancelReason:reason});
            refreshInternal(); renderSlots();
            return;
          }
        });
      });
    }

    $("refreshBtn").addEventListener("click", refreshInternal);

    /*********************
     * Excel export
     *********************/
    $("exportExcelBtn").addEventListener("click", ()=>{
      autoCompleteIfNeeded();
      const data = loadAll().map(b=>({
        Status: statusLabel(b),
        Date: b.date,
        Slot: `${b.start}-${b.end}`,
        Company: b.company,
        Plate: b.plate,
        Phone: b.phone,
        PackageNo: b.packageNo,
        BookingID: b.id,
        ArrivedAt: b.arrivedAt ? new Date(b.arrivedAt).toLocaleString() : "",
        DoneAt: b.doneAt ? new Date(b.doneAt).toLocaleString() : "",
        CancelReason: b.cancelReason || "",
        CompletedAutomatically: b.completedAutomatically ? "YES" : "NO"
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Bookings");
      XLSX.writeFile(wb, "truck_unloading_bookings.xlsx");
    });

    /*********************
     * Scan: find + popup
     *********************/
    $("findBtn").addEventListener("click", ()=>{
      const id = $("scanId").value.trim();
      if(!id){
        showBox($("scanInline"), "Missing", "Paste Booking ID or scan it.", "bad");
        return;
      }
      const b = loadAll().find(x=>x.id===id);
      if(!b){
        showBox($("scanInline"), "Not found", "No booking found with this ID.", "bad");
        return;
      }
      $("scanInline").style.display="none";
      openDetailsModal(b);
    });

    $("focusScanBtn").addEventListener("click", ()=>{
      $("scanId").focus();
      $("scanId").select();
    });

    /*********************
     * Details Modal + actions
     *********************/
    let modalBookingId=null;

    function fmtDT(iso){
      if(!iso) return "‚Äî";
      try{ return new Date(iso).toLocaleString(); }catch(e){ return iso; }
    }

    function openModal(id){
      const el=$(id);
      el.style.display="flex";
      el.onclick = (e)=>{ if(e.target===el) closeModal(id); };
      document.addEventListener("keydown", escClose);
      function escClose(ev){ if(ev.key==="Escape") closeModal(id); }
      el._esc=escClose;
    }
    function closeModal(id){
      const el=$(id);
      el.style.display="none";
      if(el._esc) document.removeEventListener("keydown", el._esc);
    }

    $("closeDetails").addEventListener("click", ()=>closeModal("detailsModal"));

    function openDetailsModal(b){
      autoCompleteIfNeeded();
      const refreshed = loadAll().find(x=>x.id===b.id) || b;
      modalBookingId = refreshed.id;

      $("m_status").textContent = statusLabel(refreshed);
      $("m_id").textContent = refreshed.id;
      $("m_date").textContent = refreshed.date;
      $("m_slot").textContent = `${refreshed.start}‚Äì${refreshed.end}`;
      $("m_company").textContent = refreshed.company || "‚Äî";
      $("m_plate").textContent = refreshed.plate || "‚Äî";
      $("m_phone").textContent = refreshed.phone || "‚Äî";
      $("m_pkg").textContent = refreshed.packageNo || "‚Äî";

      $("m_autoWrap").style.display = refreshed.completedAutomatically ? "block" : "none";
      $("m_cancelWrap").style.display = refreshed.cancelled ? "block" : "none";
      $("m_cancelReason").textContent = refreshed.cancelReason || "‚Äî";

      $("m_arrivedWrap").style.display = refreshed.arrivedAt ? "block" : "none";
      $("m_arrivedAt").textContent = fmtDT(refreshed.arrivedAt);

      $("m_doneWrap").style.display = refreshed.doneAt ? "block" : "none";
      $("m_doneAt").textContent = fmtDT(refreshed.doneAt);

      $("m_arrived").disabled = !!refreshed.cancelled || !!refreshed.arrivedAt || !!refreshed.doneAt;
      $("m_done").disabled = !!refreshed.cancelled || !!refreshed.doneAt;

      openModal("detailsModal");
    }

    $("m_arrived").addEventListener("click", ()=>{
      if(!modalBookingId) return;
      const b = updateBooking(modalBookingId,{arrivedAt:new Date().toISOString(), completedAutomatically:false});
      if(b){ openDetailsModal(b); refreshInternal(); renderSlots(); }
    });
    $("m_done").addEventListener("click", ()=>{
      if(!modalBookingId) return;
      const b = updateBooking(modalBookingId,{doneAt:new Date().toISOString(), completedAutomatically:false});
      if(b){ openDetailsModal(b); refreshInternal(); renderSlots(); }
    });

    /*********************
     * Camera scanner (BarcodeDetector)
     *********************/
    let scanStream=null;
    let scanRunning=false;
    let useFront=false;
    let raf=null;

    function setScanStatus(t){ $("scanStatusText").textContent=t; }

    function stopScanner(){
      scanRunning=false;
      if(raf) cancelAnimationFrame(raf);
      raf=null;

      const v=$("scanVideo");
      try{ v.pause(); }catch(e){}
      try{ v.srcObject=null; }catch(e){}

      if(scanStream){
        try{ scanStream.getTracks().forEach(t=>t.stop()); }catch(e){}
      }
      scanStream=null;
      setScanStatus("Stopped.");
    }

    function closeScanner(){
      stopScanner();
      closeModal("scannerModal");
    }

    $("closeScanner").addEventListener("click", closeScanner);
    $("stopCamBtn").addEventListener("click", closeScanner);

    $("switchCamBtn").addEventListener("click", async ()=>{
      useFront=!useFront;
      if(scanRunning){
        stopScanner();
        await startScanner();
      }
    });

    async function startScanner(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert("Camera not available on this browser/device.");
        return;
      }
      openModal("scannerModal");
      setScanStatus("Starting camera‚Ä¶");

      try{
        scanStream = await navigator.mediaDevices.getUserMedia({
          audio:false,
          video:{ facingMode: useFront ? "user" : "environment" }
        });
      }catch(e){
        console.error(e);
        setScanStatus("Camera permission denied or unavailable.");
        return;
      }

      const v=$("scanVideo");
      v.srcObject=scanStream;
      await v.play();

      if(!("BarcodeDetector" in window)){
        setScanStatus("BarcodeDetector not supported. Use manual paste.");
        return;
      }

      let detector;
      try{
        detector = new BarcodeDetector({ formats:["qr_code","code_128","ean_13","ean_8","code_39","code_93","itf","upc_a","upc_e"] });
      }catch(e){
        detector = new BarcodeDetector();
      }

      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d");

      scanRunning=true;
      setScanStatus("Scanning‚Ä¶");

      const tick = async ()=>{
        if(!scanRunning) return;
        try{
          if(v.readyState>=2){
            canvas.width = v.videoWidth || 1280;
            canvas.height = v.videoHeight || 720;
            ctx.drawImage(v,0,0,canvas.width,canvas.height);
            const bmp = await createImageBitmap(canvas);
            const codes = await detector.detect(bmp);
            if(codes && codes.length){
              const raw = (codes[0].rawValue||"").trim();
              if(raw){
                stopScanner();
                closeModal("scannerModal");
                $("scanId").value = raw;
                const b = loadAll().find(x=>x.id===raw);
                if(b) openDetailsModal(b);
                else showBox($("scanInline"), "Not found", "Scanned code but booking not found.", "bad");
                return;
              }
            }
          }
        }catch(e){}
        raf=requestAnimationFrame(tick);
      };
      raf=requestAnimationFrame(tick);
    }

    $("openCameraBtn").addEventListener("click", startScanner);

    /*********************
     * PDF generation (Carrier/Internal/Cancelled)
     *********************/
    async function waitForLibs(){
      // Wait for libs loaded
      const max=80;
      for(let i=0;i<max;i++){
        if(window.jspdf && window.jspdf.jsPDF && window.QRCode && window.JsBarcode) return;
        await new Promise(r=>setTimeout(r,50));
      }
      throw new Error("Libraries not loaded. Check internet/CDN.");
    }

    function downloadBlob(filename, blob){
      // Works on Edge/Chrome/Safari
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url;
      a.download=filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 250);
    }

    function makeQrDataUrl(text){
      // Use QRCode to render into temp element then toDataURL via canvas
      const tmp=document.createElement("div");
      tmp.style.position="fixed";
      tmp.style.left="-9999px";
      tmp.style.top="-9999px";
      document.body.appendChild(tmp);
      new QRCode(tmp, { text, width:160, height:160, correctLevel: QRCode.CorrectLevel.M });
      const canvas = tmp.querySelector("canvas");
      const url = canvas ? canvas.toDataURL("image/png") : "";
      tmp.remove();
      return url;
    }

    function makeBarcodeDataUrl(text){
      const canvas=document.createElement("canvas");
      JsBarcode(canvas, text, {
        format:"CODE128",
        displayValue:false,
        margin:0,
        height:60
      });
      return canvas.toDataURL("image/png");
    }

    async function generatePdf(booking, mode){
      await waitForLibs();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const W = doc.internal.pageSize.getWidth();
      const H = doc.internal.pageSize.getHeight();

      const isInternal = (mode==="internal");
      const isCancelled = !!booking.cancelled;

      // Background header
      doc.setFillColor(8,17,27);
      doc.rect(0,0,W,110,"F");
      doc.setFillColor(46,168,255);
      doc.rect(0,0,W,4,"F");

      doc.setTextColor(234,242,255);
      doc.setFont("helvetica","bold");
      doc.setFontSize(18);
      doc.text("Truck Unloading Ticket", 40, 48);

      doc.setFontSize(10);
      doc.setFont("helvetica","normal");
      doc.setTextColor(200,215,235);
      doc.text(isInternal ? "INTERNAL COPY (locked)" : "CARRIER COPY", 40, 68);

      // Status
      const st = statusLabel(booking);
      doc.setFont("helvetica","bold");
      doc.setTextColor(255,255,255);
      doc.setFontSize(11);
      doc.text(`STATUS: ${st}`, W-200, 52);

      // Card
      doc.setDrawColor(220);
      doc.setFillColor(255,255,255);
      doc.roundedRect(30, 125, W-60, 360, 16, 16, "F");

      // Cancelled overlay
      if(isCancelled){
        doc.setTextColor(255,77,77);
        doc.setFontSize(120);
        doc.setFont("helvetica","bold");
        doc.text("X", W/2, H/2+40, { align:"center", angle: 15 });
        doc.setFontSize(42);
        doc.text("CANCELLED", W/2, 250, { align:"center", angle: 0 });
      }

      // Fields
      doc.setTextColor(15, 30, 45);
      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.text("Booking", 50, 160);

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);

      const leftX=50, rightX=W/2+10;
      const y0=185, lh=20;

      const linesLeft = [
        ["Booking ID", booking.id],
        ["Date", booking.date],
        ["Slot", `${booking.start} ‚Äì ${booking.end}`],
        ["Company", booking.company],
        ["Truck plate", booking.plate],
        ["Driver phone", booking.phone],
        ["Package No", booking.packageNo],
      ];

      const linesRight = [
        ["Arrived", booking.arrivedAt ? new Date(booking.arrivedAt).toLocaleString() : "‚Äî"],
        ["Done", booking.doneAt ? new Date(booking.doneAt).toLocaleString() : "‚Äî"],
        ["Auto complete", booking.completedAutomatically ? "YES" : "NO"],
        ["Cancel reason", booking.cancelReason || "‚Äî"],
      ];

      let y=y0;
      for(const [k,v] of linesLeft){
        doc.setFont("helvetica","bold"); doc.text(`${k}:`, leftX, y);
        doc.setFont("helvetica","normal"); doc.text(String(v||"‚Äî"), leftX+105, y);
        y+=lh;
      }

      y=y0;
      for(const [k,v] of linesRight){
        doc.setFont("helvetica","bold"); doc.text(`${k}:`, rightX, y);
        doc.setFont("helvetica","normal"); doc.text(String(v||"‚Äî"), rightX+105, y);
        y+=lh;
      }

      // Barcode + QR
      const qr = makeQrDataUrl(booking.id);
      const bc = makeBarcodeDataUrl(booking.id);

      if(bc){
        doc.addImage(bc, "PNG", 50, 360, 320, 64);
      }
      if(qr){
        doc.addImage(qr, "PNG", W-180, 340, 120, 120);
      }

      doc.setTextColor(120,130,140);
      doc.setFontSize(9);
      doc.text("Scan barcode or QR to retrieve shipment quickly.", 50, 450);

      // Internal extra note
      if(isInternal){
        doc.setTextColor(15, 30, 45);
        doc.setFont("helvetica","bold");
        doc.setFontSize(11);
        doc.text("Internal notes", 50, 505);
        doc.setFont("helvetica","normal");
        doc.setFontSize(10);
        doc.text("Use ARRIVED when truck checks-in. Use DONE after unloading. Auto done triggers after slot end.", 50, 525, { maxWidth: W-100 });
      }

      // Output
      const safeId = cleanPart(booking.id);
      const statusTag = booking.cancelled ? "CANCELLED" : "ACTIVE";
      const modeTag = isInternal ? "INTERNAL" : "CARRIER";
      const fileName = `UNLOADING_${modeTag}_${statusTag}_${booking.date}_${booking.start.replace(":","")}_${safeId}.pdf`;

      const arrayBuffer = doc.output("arraybuffer");
      const blob = new Blob([arrayBuffer], { type:"application/pdf" });
      downloadBlob(fileName, blob);
    }

    $("downloadCarrierPdfBtn").addEventListener("click", async ()=>{
      if(!lastBookingId) return;
      const b = loadAll().find(x=>x.id===lastBookingId);
      if(!b) return;
      try{ await generatePdf(b, "carrier"); }
      catch(e){ alert("PDF error: " + e.message); console.error(e); }
    });

    $("downloadInternalPdfBtn").addEventListener("click", async ()=>{
      if(!lastBookingId) return;
      const b = loadAll().find(x=>x.id===lastBookingId);
      if(!b) return;
      try{ await generatePdf(b, "internal"); }
      catch(e){ alert("PDF error: " + e.message); console.error(e); }
    });

    $("m_pdfCarrier").addEventListener("click", async ()=>{
      if(!modalBookingId) return;
      const b = loadAll().find(x=>x.id===modalBookingId);
      if(!b) return;
      try{ await generatePdf(b, "carrier"); }catch(e){ alert("PDF error: "+e.message); }
    });
    $("m_pdfInternal").addEventListener("click", async ()=>{
      if(!modalBookingId) return;
      const b = loadAll().find(x=>x.id===modalBookingId);
      if(!b) return;
      try{ await generatePdf(b, "internal"); }catch(e){ alert("PDF error: "+e.message); }
    });
    $("m_pdfCancelled").addEventListener("click", async ()=>{
      if(!modalBookingId) return;
      const b = loadAll().find(x=>x.id===modalBookingId);
      if(!b) return;
      try{ await generatePdf({...b, cancelled:true}, "carrier"); }catch(e){ alert("PDF error: "+e.message); }
    });

    /*********************
     * Escape HTML
     *********************/
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /*********************
     * Init
     *********************/
    $("dateInput").value = todayISO();
    // render immediately
    renderSlots();

    // auto-complete timer
    setInterval(()=>{
      const changed=autoCompleteIfNeeded();
      if(changed){
        renderSlots();
        refreshInternal();
      }
    }, 60000);
  </script>
</body>
</html>
